"""
날씨 기반 음식 추천 모듈 (Rule-Based)
- OpenWeather API로 실시간 날씨 조회
- 날씨 + 온도 구간에 따라 미리 정의된 음식 카테고리 추천
"""

import requests
import os
from dotenv import load_dotenv

# 환경 변수 로드
load_dotenv()
API_KEY = os.getenv("OPEN_WEATHER_API")

# 지거국 10곳 좌표 정보
UNIVERSITIES = {
    "서울대학교": {"lat": 37.4599, "lon": 126.9519, "short_name": "서울대"},
    "부산대학교": {"lat": 35.2330, "lon": 129.0780, "short_name": "부산대"},
    "경북대학교": {"lat": 35.8906, "lon": 128.6122, "short_name": "경북대"},
    "전북대학교": {"lat": 35.8468, "lon": 127.1290, "short_name": "전북대"},
    "전남대학교": {"lat": 35.1760, "lon": 126.9059, "short_name": "전남대"},
    "경상국립대학교": {"lat": 35.1515, "lon": 128.0983, "short_name": "경상국립대"},
    "충북대학교": {"lat": 36.6284, "lon": 127.4560, "short_name": "충북대"},
    "충남대학교": {"lat": 36.3665, "lon": 127.3446, "short_name": "충남대"},
    "강원대학교": {"lat": 37.8695, "lon": 127.7449, "short_name": "강원대"},
    "제주대학교": {"lat": 33.4520, "lon": 126.5675, "short_name": "제주대"}
}

# 8개 대분류 카테고리
ALL_CATEGORIES = [
    "한식",
    "일식",
    "카페/디저트",
    "양식/브런치",
    "고기/구이/치킨",
    "중식/아시아",
    "술집/이자카야",
    "기타"
]

# 온도 구간 정의 함수
def get_temperature_range(temp):
    """
    온도를 사람이 느끼는 기준으로 구간화
    """
    if temp < -5:
        return "혹한"
    elif -5 <= temp < 5:
        return "한겨울"
    elif 5 <= temp < 12:
        return "쌀쌀"
    elif 12 <= temp < 20:
        return "선선"
    elif 20 <= temp < 25:
        return "쾌적"
    elif 25 <= temp < 30:
        return "더움"
    else:
        return "폭염"

# 날씨 상태 정규화 함수
def normalize_weather(main):
    """
    OpenWeather의 main 값을 내부 기준으로 변환
    """
    if main == "Clear":
        return "CLEAR"
    elif main == "Clouds":
        return "CLOUDY"
    elif main in ["Rain", "Drizzle"]:
        return "RAIN"
    elif main == "Thunderstorm":
        return "STORM"
    elif main == "Snow":
        return "SNOW"
    elif main in ["Mist", "Fog", "Haze"]:
        return "FOG"
    else:
        return "UNKNOWN"

# 날씨 × 온도별 카테고리 우선순위 테이블
# 분식/간편식 -> 술집/이자카야로 변경 및 한국 식문화 반영
CATEGORY_PRIORITY_TABLE = {
    # ---------------- CLEAR (맑음) ----------------
    # 맑고 추울 땐 뜨끈한 국물이나 불판 앞이 최고
    ("CLEAR", "혹한"): {
        "한식": 1,           # 국밥/찌개
        "고기/구이/치킨": 2, # 숯불 앞
        "중식/아시아": 3,    # 따뜻한 국물(짬뽕/쌀국수)
        "일식": 4,           # 따뜻한 우동/나베
        "술집/이자카야": 5,  # 사케/오뎅탕
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("CLEAR", "한겨울"): {
        "한식": 1,
        "고기/구이/치킨": 2,
        "중식/아시아": 3,
        "일식": 4,
        "술집/이자카야": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("CLEAR", "쌀쌀"): {
        "한식": 1,
        "일식": 2,           # 라멘/우동
        "고기/구이/치킨": 3,
        "중식/아시아": 4,
        "양식/브런치": 5,
        "술집/이자카야": 6,
        "카페/디저트": 7
    },
    # 맑고 날씨 좋을 땐 데이트/외식 선호
    ("CLEAR", "선선"): {
        "양식/브런치": 1,    # 테라스/데이트
        "고기/구이/치킨": 2, # 치맥하기 좋은 날
        "일식": 3,           # 스시/사시미
        "한식": 4,
        "카페/디저트": 5,    # 걷다가 카페
        "술집/이자카야": 6,
        "중식/아시아": 7
    },
    ("CLEAR", "쾌적"): {
        "양식/브런치": 1,
        "카페/디저트": 2,
        "일식": 3,
        "고기/구이/치킨": 4,
        "한식": 5,
        "술집/이자카야": 6,
        "중식/아시아": 7
    },
    # 맑고 더울 땐 시원한 면요리, 카페
    ("CLEAR", "더움"): {
        "카페/디저트": 1,    # 빙수/아아
        "일식": 2,           # 소바/스시
        "한식": 3,           # 냉면
        "양식/브런치": 4,
        "중식/아시아": 5,    # 냉짬뽕/분짜
        "술집/이자카야": 6,  # 시원한 생맥주
        "고기/구이/치킨": 7  # 불판 더움
    },
    ("CLEAR", "폭염"): {
        "카페/디저트": 1,
        "일식": 2,
        "한식": 3,           # 이열치열 삼계탕 or 냉면
        "술집/이자카야": 4,  # 생맥주 필수
        "양식/브런치": 5,
        "중식/아시아": 6,
        "고기/구이/치킨": 7  # 너무 더움
    },

    # ---------------- CLOUDY (흐림) ----------------
    # 흐린 날은 기분 전환용 음식이나 국물
    ("CLOUDY", "혹한"): {
        "한식": 1,
        "중식/아시아": 2,    # 마라탕/쌀국수
        "고기/구이/치킨": 3,
        "일식": 4,
        "술집/이자카야": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("CLOUDY", "한겨울"): {
        "한식": 1,
        "고기/구이/치킨": 2,
        "중식/아시아": 3,
        "일식": 4,
        "술집/이자카야": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("CLOUDY", "쌀쌀"): {
        "중식/아시아": 1,    # 흐린날 짬뽕/쌀국수 인기
        "한식": 2,
        "고기/구이/치킨": 3,
        "일식": 4,
        "술집/이자카야": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("CLOUDY", "선선"): {
        "고기/구이/치킨": 1,
        "술집/이자카야": 2,  # 흐린날 술 한잔
        "한식": 3,
        "일식": 4,
        "중식/아시아": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("CLOUDY", "쾌적"): {
        "일식": 1,
        "양식/브런치": 2,
        "카페/디저트": 3,
        "한식": 4,
        "고기/구이/치킨": 5,
        "술집/이자카야": 6,
        "중식/아시아": 7
    },
    ("CLOUDY", "더움"): {
        "카페/디저트": 1,
        "일식": 2,
        "중식/아시아": 3,
        "한식": 4,
        "양식/브런치": 5,
        "술집/이자카야": 6,
        "고기/구이/치킨": 7
    },
    ("CLOUDY", "폭염"): {
        "카페/디저트": 1,
        "중식/아시아": 2,
        "일식": 3,
        "술집/이자카야": 4,
        "한식": 5,
        "양식/브런치": 6,
        "고기/구이/치킨": 7
    },

    # ---------------- RAIN (비) ----------------
    # 비 오는 날 국룰: 전(한식), 짬뽕(중식), 막걸리(술집)
    ("RAIN", "혹한"): {
        "한식": 1,           # 김치전/찌개
        "중식/아시아": 2,    # 짬뽕
        "술집/이자카야": 3,  # 비오는날 술
        "고기/구이/치킨": 4,
        "일식": 5,           # 따뜻한 국물
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("RAIN", "한겨울"): {
        "한식": 1,
        "술집/이자카야": 2,
        "중식/아시아": 3,
        "고기/구이/치킨": 4,
        "일식": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("RAIN", "쌀쌀"): {
        "한식": 1,           # 파전/칼국수
        "술집/이자카야": 2,  # 막걸리
        "중식/아시아": 3,    # 짬뽕/우육면
        "일식": 4,           # 라멘
        "고기/구이/치킨": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("RAIN", "선선"): {
        "술집/이자카야": 1,
        "한식": 2,
        "고기/구이/치킨": 3, # 빗소리와 고기 굽는 소리
        "중식/아시아": 4,
        "일식": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("RAIN", "쾌적"): {
        "술집/이자카야": 1,
        "한식": 2,
        "양식/브런치": 3,    # 분위기 있는 식사
        "고기/구이/치킨": 4,
        "일식": 5,
        "중식/아시아": 6,
        "카페/디저트": 7
    },
    ("RAIN", "더움"): {
        "술집/이자카야": 1,  # 습할 땐 맥주
        "카페/디저트": 2,    # 에어컨 피신
        "한식": 3,
        "중식/아시아": 4,
        "일식": 5,
        "고기/구이/치킨": 6,
        "양식/브런치": 7
    },
    ("RAIN", "폭염"): {
        "카페/디저트": 1,
        "술집/이자카야": 2,
        "일식": 3,
        "한식": 4,
        "중식/아시아": 5,
        "양식/브런치": 6,
        "고기/구이/치킨": 7
    },

    # ---------------- SNOW (눈) ----------------
    # 눈 오는 날: 로맨틱(양식), 따뜻함(일식/술집), 국물(한식)
    ("SNOW", "혹한"): {
        "일식": 1,           # 눈 오는 날 이자카야/우동 감성
        "한식": 2,
        "술집/이자카야": 3,
        "고기/구이/치킨": 4,
        "중식/아시아": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("SNOW", "한겨울"): {
        "일식": 1,
        "술집/이자카야": 2,  # 사케
        "한식": 3,
        "고기/구이/치킨": 4,
        "양식/브런치": 5,    # 분위기
        "중식/아시아": 6,
        "카페/디저트": 7
    },
    ("SNOW", "쌀쌀"): {
        "양식/브런치": 1,    # 눈 오는 뷰
        "카페/디저트": 2,
        "일식": 3,
        "술집/이자카야": 4,
        "한식": 5,
        "고기/구이/치킨": 6,
        "중식/아시아": 7
    },
    # 눈이 오는데 덥거나 쾌적할 일은 거의 없으므로 나머지는 일반적인 겨울 로직
    ("SNOW", "선선"): { # 드문 케이스
        "카페/디저트": 1,
        "양식/브런치": 2,
        "일식": 3,
        "술집/이자카야": 4,
        "한식": 5,
        "고기/구이/치킨": 6,
        "중식/아시아": 7
    },
    ("SNOW", "쾌적"): { # 드문 케이스
        "카페/디저트": 1,
        "양식/브런치": 2,
        "일식": 3,
        "술집/이자카야": 4,
        "한식": 5,
        "고기/구이/치킨": 6,
        "중식/아시아": 7
    },
    ("SNOW", "더움"): { # 이상 기후
        "카페/디저트": 1,
        "일식": 2,
        "양식/브런치": 3,
        "술집/이자카야": 4,
        "한식": 5,
        "고기/구이/치킨": 6,
        "중식/아시아": 7
    },
    ("SNOW", "폭염"): { # 불가능
        "카페/디저트": 1,
        "일식": 2,
        "양식/브런치": 3,
        "술집/이자카야": 4,
        "한식": 5,
        "고기/구이/치킨": 6,
        "중식/아시아": 7
    },

    # ---------------- STORM (폭풍/천둥) ----------------
    # 배달이나 가까운 곳, 스트레스 풀리는 고칼로리/매운맛
    ("STORM", "혹한"): {
        "한식": 1,           # 든든한 국밥
        "중식/아시아": 2,    # 짬뽕
        "고기/구이/치킨": 3,
        "술집/이자카야": 4,
        "일식": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("STORM", "한겨울"): {
        "한식": 1,
        "고기/구이/치킨": 2,
        "중식/아시아": 3,
        "술집/이자카야": 4,
        "일식": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("STORM", "쌀쌀"): {
        "고기/구이/치킨": 1, # 기름진 것
        "한식": 2,
        "중식/아시아": 3,
        "술집/이자카야": 4,
        "일식": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("STORM", "선선"): {
        "고기/구이/치킨": 1,
        "술집/이자카야": 2,
        "한식": 3,
        "중식/아시아": 4,
        "일식": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("STORM", "쾌적"): {
        "고기/구이/치킨": 1,
        "술집/이자카야": 2,
        "한식": 3,
        "중식/아시아": 4,
        "양식/브런치": 5,
        "일식": 6,
        "카페/디저트": 7
    },
    ("STORM", "더움"): {
        "고기/구이/치킨": 1,
        "술집/이자카야": 2,  # 맥주
        "카페/디저트": 3,
        "중식/아시아": 4,
        "한식": 5,
        "일식": 6,
        "양식/브런치": 7
    },
    ("STORM", "폭염"): {
        "카페/디저트": 1,
        "술집/이자카야": 2,
        "고기/구이/치킨": 3,
        "중식/아시아": 4,
        "일식": 5,
        "한식": 6,
        "양식/브런치": 7
    },

    # ---------------- FOG (안개) ----------------
    # 분위기 타는 날: 술집, 양식(와인), 따뜻한 국물
    ("FOG", "혹한"): {
        "술집/이자카야": 1,  # 분위기
        "한식": 2,
        "일식": 3,
        "고기/구이/치킨": 4,
        "중식/아시아": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("FOG", "한겨울"): {
        "술집/이자카야": 1,
        "한식": 2,
        "일식": 3,
        "고기/구이/치킨": 4,
        "중식/아시아": 5,
        "양식/브런치": 6,
        "카페/디저트": 7
    },
    ("FOG", "쌀쌀"): {
        "술집/이자카야": 1,
        "일식": 2,           # 라멘/우동
        "양식/브런치": 3,
        "한식": 4,
        "고기/구이/치킨": 5,
        "중식/아시아": 6,
        "카페/디저트": 7
    },
    ("FOG", "선선"): {
        "양식/브런치": 1,    # 안개 낀 날 무드
        "술집/이자카야": 2,
        "일식": 3,
        "카페/디저트": 4,
        "한식": 5,
        "고기/구이/치킨": 6,
        "중식/아시아": 7
    },
    ("FOG", "쾌적"): {
        "양식/브런치": 1,
        "카페/디저트": 2,
        "술집/이자카야": 3,
        "일식": 4,
        "한식": 5,
        "고기/구이/치킨": 6,
        "중식/아시아": 7
    },
    ("FOG", "더움"): {
        "카페/디저트": 1,
        "술집/이자카야": 2,
        "양식/브런치": 3,
        "일식": 4,
        "중식/아시아": 5,
        "한식": 6,
        "고기/구이/치킨": 7
    },
    ("FOG", "폭염"): {
        "카페/디저트": 1,
        "술집/이자카야": 2,
        "양식/브런치": 3,
        "일식": 4,
        "중식/아시아": 5,
        "한식": 6,
        "고기/구이/치킨": 7
    }
}

# 날씨 조회 함수
def get_weather_by_university(university_name):
    """
    대학 이름을 받아 해당 위치의 현재 날씨를 조회
    """
    if not API_KEY:
        return {"success": False, "error": "OpenWeather API 키가 없습니다."}

    if university_name not in UNIVERSITIES:
        return {"success": False, "error": "존재하지 않는 대학입니다."}

    coord = UNIVERSITIES[university_name]

    try:
        url = "https://api.openweathermap.org/data/2.5/weather"
        params = {
            "lat": coord["lat"],
            "lon": coord["lon"],
            "appid": API_KEY,
            "units": "metric",
            "lang": "kr"
        }

        response = requests.get(url, params=params, timeout=10)
        data = response.json()

        return {
            "success": True,
            "university": university_name,
            "temperature": round(data["main"]["temp"], 1),
            "feels_like": round(data["main"]["feels_like"], 1),
            "description": data["weather"][0]["description"],
            "humidity": data["main"]["humidity"],
            "main": data["weather"][0]["main"]
        }

    except Exception as e:
        return {"success": False, "error": str(e)}

# 음식 추천 함수 (Rule-Based)
def get_food_recommendation_by_weather(weather_data):
    """
    날씨 정보를 기반으로 음식 카테고리 추천

    Returns:
        dict: {
            "success": bool,
            "categories": list (대분류 카테고리 - DB 조회용),
            "detail_categories": list (소분류 카테고리 - 추천 문구용),
            "recommendation_text": str
        }
    """
    if not weather_data.get("success"):
        return {"success": False, "error": "날씨 정보 오류"}

    # 온도 구간 계산
    temp_range = get_temperature_range(weather_data["temperature"])

    # 날씨 정규화
    weather_category = normalize_weather(weather_data["main"])

    # 추천 테이블 조회 (소분류)
    key = (weather_category, temp_range)
    priority_dict = CATEGORY_PRIORITY_TABLE.get(key)

    # 키가 없는 경우 기본값 설정
    if not priority_dict:
        priority_dict = {cat: i+1 for i, cat in enumerate(ALL_CATEGORIES)}

    # 우선순위 순으로 정렬
    ranked_categories = sorted(
        [{"category": cat, "priority": pri} for cat, pri in priority_dict.items()],
        key=lambda x: x["priority"]
    )

    # 우선순위 순서대로 카테고리명만 추출 (main_list에서 이 순서대로 표시)
    categories = [item["category"] for item in ranked_categories]

    # 상위 3개 추출
    top_categories = categories[:3]

    # 사용자에게 보여줄 문구 생성
    recommendation_text = f"""
오늘 {weather_data['university']}의 날씨는
{weather_data['description']}이고, 기온은 {weather_data['temperature']}°C 입니다.

이런 {temp_range} 날씨에는
{', '.join(top_categories)} 순으로 추천해요!
"""

    return {
        "success": True,
        "ranked_categories": ranked_categories,  # 전체 카테고리 순위 (상세 정보 포함)
        "categories": categories,                # 우선순위 순 카테고리명 리스트 (main_list용)
        "top_categories": top_categories,        # 상위 3개
        "recommendation_text": recommendation_text.strip()
    }

# 모든 대학 정보 반환
def get_all_universities():
    """
    모든 대학 정보를 반환하는 함수
    
    Returns:
        dict: 대학 정보 딕셔너리
    """
    return UNIVERSITIES

# 실행 예제
if __name__ == "__main__":
    weather = get_weather_by_university("부산대학교")
    result = get_food_recommendation_by_weather(weather)

    print(result["recommendation_text"])
    print("\n전체 카테고리 순위:")
    for item in result["ranked_categories"]:
        print(f"  {item['priority']}위: {item['category']}")