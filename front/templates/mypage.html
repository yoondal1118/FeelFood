<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .mypage-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .mypage-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .mypage-title {
            font-size: 32px;
            color: #e67e22;
            margin-bottom: 10px;
        }

        .mypage-subtitle {
            font-size: 16px;
            color: #666;
        }

        .profile-section {
            background: white;
            padding: 30px;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f5f5f5;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f6b26b, #f4a261);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .profile-details {
            flex: 1;
        }

        .profile-name {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .profile-email {
            font-size: 16px;
            color: #666;
            margin-bottom: 4px;
        }

        .profile-birth {
            font-size: 14px;
            color: #999;
        }

        .menu-section {
            background: white;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 30px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: #fff4ec;
        }

        .menu-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }

        .menu-text {
            font-size: 16px;
            color: #333;
        }

        .menu-arrow {
            font-size: 20px;
            color: #999;
        }

        .logout-section {
            margin-top: 20px;
            text-align: center;
        }

        .logout-btn {
            background: #95a5a6;
            color: white;
            padding: 12px 40px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        /* ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 14px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
            font-size: 24px;
            font-weight: bold;
            color: #e67e22;
            margin-bottom: 30px;
            text-align: center;
        }

        .modal-form label {
            display: block;
            font-size: 14px;
            margin-bottom: 6px;
            color: #555;
        }

        .modal-form input {
            width: 100%;
            padding: 14px;
            margin-bottom: 6px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .modal-form input:focus {
            outline: none;
            border-color: #f4a261;
            box-shadow: 0 0 0 2px rgba(244, 162, 97, 0.3);
        }

        .modal-msg {
            font-size: 12px;
            margin-bottom: 14px;
            min-height: 18px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-submit {
            background: linear-gradient(135deg, #f6b26b, #f4a261);
            color: white;
        }

        .modal-btn-cancel {
            background: #95a5a6;
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .profile-info {
                flex-direction: column;
                text-align: center;
            }

            .menu-item {
                padding: 16px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="mypage-container">
        <div class="mypage-header">
            <h1 class="mypage-title">ë§ˆì´í˜ì´ì§€</h1>
            <p class="mypage-subtitle">ë‚´ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>

        <!-- í”„ë¡œí•„ ì„¹ì…˜ -->
        <div class="profile-section">
            <div class="profile-info">
                <div class="profile-avatar" id="profileAvatar">
                    <!-- ì´ë¦„ ì²« ê¸€ì í‘œì‹œ -->
                </div>
                <div class="profile-details">
                    <div class="profile-name" id="profileName">{{ user_name }}</div>
                    <div class="profile-email" id="profileEmail">user@example.com</div>
                    <div class="profile-birth" id="profileBirth">ìƒë…„ì›”ì¼: </div>
                </div>
            </div>
        </div>

        <!-- ë©”ë‰´ ì„¹ì…˜ -->
        <div class="menu-section">
            <div class="menu-item" onclick="openPasswordModal()">
                <div class="menu-left">
                    <div class="menu-icon">ğŸ”’</div>
                    <div class="menu-text">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
                </div>
                <div class="menu-arrow">â€º</div>
            </div>

            <!-- <div class="menu-item" onclick="goToFavorites()">
                <div class="menu-left">
                    <div class="menu-icon">â¤ï¸</div>
                    <div class="menu-text">ì°œí•œ ë§›ì§‘</div>
                </div>
                <div class="menu-arrow">â€º</div>
            </div> -->
        </div>

        <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
        <div class="logout-section">
            <a href="./"><button class="logout-btn">ì²˜ìŒìœ¼ë¡œ</button></a>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
            <form class="modal-form" id="passwordForm">
                <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="currentPassword" required>
                <div class="modal-msg" id="currentPasswordMsg"></div>

                <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="newPassword" required>
                <div class="modal-msg" id="newPasswordMsg">
                    ì˜ë¬¸/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ì(!~@#) ì¤‘ 2ê°€ì§€ ì´ìƒ, 6ì ì´ìƒ
                </div>

                <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="confirmPassword" required>
                <div class="modal-msg" id="confirmPasswordMsg"></div>

                <div class="modal-buttons">
                    <button type="button" class="modal-btn modal-btn-cancel" onclick="closePasswordModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="modal-btn modal-btn-submit">ë³€ê²½í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/user/profile');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('profileName').textContent = data.name;
                    document.getElementById('profileEmail').textContent = data.email;
                    document.getElementById('profileBirth').textContent = `ìƒë…„ì›”ì¼: ${data.birth}`;
                    document.getElementById('profileAvatar').textContent = data.name.charAt(0);
                }
            } catch (error) {
                console.error('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        });

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        function openPasswordModal() {
            document.getElementById('passwordModal').classList.add('active');
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
            document.getElementById('passwordForm').reset();
            clearPasswordMessages();
        }

        function clearPasswordMessages() {
            document.getElementById('currentPasswordMsg').textContent = '';
            document.getElementById('newPasswordMsg').textContent = 'ì˜ë¬¸/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ì(!~@#) ì¤‘ 2ê°€ì§€ ì´ìƒ, 6ì ì´ìƒ';
            document.getElementById('confirmPasswordMsg').textContent = '';
        }

        // ìƒˆ ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
        document.getElementById('newPassword').addEventListener('input', function() {
            const v = this.value;
            const msg = document.getElementById('newPasswordMsg');

            const count = /[A-Za-z]/.test(v) + /[0-9]/.test(v) + /[!~@#]/.test(v);

            if (v.length < 6 || count < 2 || /[^A-Za-z0-9!~@#]/.test(v)) {
                msg.style.color = 'red';
                msg.textContent = 'ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                return;
            }

            msg.style.color = 'green';
            msg.textContent = 'ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.';
        });

        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ê²€ì‚¬
        document.getElementById('confirmPassword').addEventListener('input', function() {
            const newPw = document.getElementById('newPassword').value;
            const confirmPw = this.value;
            const msg = document.getElementById('confirmPasswordMsg');

            if (confirmPw && newPw !== confirmPw) {
                msg.style.color = 'red';
                msg.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            } else if (confirmPw && newPw === confirmPw) {
                msg.style.color = 'green';
                msg.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.';
            } else {
                msg.textContent = '';
            }
        });

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì œì¶œ
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // ìœ íš¨ì„± ê²€ì‚¬
            const count = /[A-Za-z]/.test(newPassword) + /[0-9]/.test(newPassword) + /[!~@#]/.test(newPassword);
            if (newPassword.length < 6 || count < 2 || /[^A-Za-z0-9!~@#]/.test(newPassword)) {
                alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const response = await fetch('/api/user/change_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closePasswordModal();
                } else {
                    const msg = document.getElementById('currentPasswordMsg');
                    msg.style.color = 'red';
                    msg.textContent = data.message || 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                }
            } catch (error) {
                alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        });

        // ì°œí•œ ë§›ì§‘ìœ¼ë¡œ ì´ë™
        function goToFavorites() {
            window.location.href = '/favorites';
        }

        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    const response = await fetch('/logout', { method: 'POST' });
                    if (response.ok) {
                        window.location.href = '/';
                    }
                } catch (error) {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
                }
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('passwordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePasswordModal();
            }
        });
    </script>
</body>
</html>