<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ restaurant.name }} - ìƒì„¸ ì •ë³´</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
        <!-- ë°±ì—”ë“œì—ì„œ ì „ë‹¬ë°›ì€ í‚¤ ì‚¬ìš© -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services"></script>
</head>
<body>
    <div class="container">
        
        <!-- ========================================== -->
        <!-- í—¤ë” -->
        <!-- ========================================== -->
        <div class="header">
            <!-- onclick="history.back()" ì‚¬ìš©ì‹œ, ë°”ë¡œ ì´ì „ í˜ì´ì§€ë¡œ ë’¤ë¡œê°€ê¸° -->
            <button class="back-btn" onclick="history.back()">
                â† ë’¤ë¡œ ê°€ê¸°
            </button>
            <h1 class="page-title">ğŸª ê°€ê²Œ ìƒì„¸ ì •ë³´</h1>
        </div>
        
        <!-- ê°€ê²Œ ê¸°ë³¸ ì •ë³´ -->
        <div class="detail-section">
            
            <!-- ê°€ê²Œ ì´ë¦„ (í¬ê²Œ í‘œì‹œ) -->
            <h2 class="detail-name">{{ restaurant.name }}</h2>
            
            <!-- ê°€ê²Œ ì£¼ì†Œ -->
            <p class="detail-address">
                ğŸ“ ì£¼ì†Œ: {{ restaurant.address }}
            </p>
            
            <!-- í‰ê·  ê°€ê²© -->
            <p class="detail-price">
                ğŸ’° í‰ê·  ê°€ê²©: {{ restaurant.get("menu").get("avg_price") }}
            </p>
            
            <!-- í•œ ì¤„ ìš”ì•½ -->
            <p class="detail-summary">
                {{ restaurant.summary }}
            </p>
            
            <!-- âœ… ì£¼ì†Œë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ -->
            <button class="map-btn" onclick="openMapPopup('{{ restaurant.address }}', '{{ restaurant.name }}')">
                ğŸ—ºï¸ ì§€ë„ë¡œ í™•ì¸í•˜ê¸°
            </button>

            <!-- íŒì—… ëª¨ë‹¬ -->
            <div id="mapPopup" class="popup-overlay" onclick="closeMapPopup()">
                <div class="popup-content" onclick="event.stopPropagation()">
                    <button class="popup-close" onclick="closeMapPopup()">Ã—</button>
                    <h2>ğŸ—ºï¸ ì˜¤ì‹œëŠ” ê¸¸</h2>
                    <p class="map-address">ì£¼ì†Œ: <span id="popupAddress"></span></p>
                    
                    <!-- ì§€ë„ê°€ í‘œì‹œë  ì˜ì—­ -->
                    <div id="kakaoMap" style="width:100%; height:400px; margin-top:15px; border-radius:8px;"></div>
                </div>
            </div>

            <!-- ë©”ë‰´ íŒì—… -->
            <button class="map-btn" onclick="openMenuPopup()">
                ğŸ½ ë©”ë‰´ í™•ì¸í•˜ê¸°
            </button>

            <!-- íŒì—… ëª¨ë‹¬ -->
            <div id="menuPopup" class="popup-overlay" onclick="closeMenuPopup()">
                <div class="popup-content" onclick="event.stopPropagation()">
                    <button class="popup-close" onclick="closeMenuPopup()">Ã—</button>
                    <h2>ğŸ½ ë©”ë‰´ í™•ì¸í•˜ê¸°</h2>
                    <div class="menu-list">
                    {% set menu_data = restaurant.get("menu") %}
                    {% for i in range(menu_data.menu_name|length) %}
                        <div class="menu-item">
                            <span class="menu-name">{{ menu_data.menu_name[i] }}</span>
                            <span class="menu-price">{{ "{:,}".format(menu_data.menu_price[i]|int) }}ì›</span>
                        </div>
                    {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ëŒ€í‘œ ê°ì„±ì§€ìˆ˜ í‘œì‹œ -->
        <div class="detail-section">
            <h3 class="section-subtitle">ğŸ’– ëŒ€í‘œ ê°ì„±ì§€ìˆ˜</h3>
            <!-- ê° ê°ì •ë³„ ì ìˆ˜ë¥¼ ë°˜ë³µí•˜ë©° í‘œì‹œ -->
            {% for emotion, score in restaurant.get("emotion_score").items() %}
                <!-- 5ê°€ì§€ ê°ì„± ì¤‘, ì œì¼ ë†’ì€ ê°’ì„ "ëŒ€í‘œ ê°ì„±"ìœ¼ë¡œ í‘œì‹œ -->
                {% if score == max_score %}
                    <div class="main-emotion">
                        <span class="emotion-label">{{ emotion }}</span>
                        <div class="emotion-bar-container">
                            <!-- ê°ì„±ì§€ìˆ˜ ë§‰ëŒ€ê·¸ë˜í”„ (CSS widthë¡œ ì‹œê°í™”) -->
                            <div class="emotion-bar main" style="width: {{ (score * 100)|round(2)  }}%">
                                {{ (score * 100)|round(2) }}%
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        
        <!-- â­ ìµœê·¼ 12ê°œì›”ê°„ ê°ì„±ì§€ìˆ˜ ë³€í™” (ë¹„ë™ê¸° ë¡œë”©) -->
        <div class="detail-section">
            <h3 class="section-subtitle">ğŸ“… ìµœê·¼ 12ê°œì›”ê°„ ê°ì„±ì§€ìˆ˜ ë³€í™”</h3>
            <p class="time-description">
                ì§€ë‚œ 12ê°œì›”ê°„ ê³ ê°ë“¤ì´ ëŠë‚€ ê°ì„±ì˜ ë³€í™”ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”! 
                ë§‰ëŒ€ ë†’ì´ëŠ” ë¦¬ë·° ê°œìˆ˜ë¥¼ ë°˜ì˜í•˜ë©°, ë§‰ëŒ€ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì •í™•í•œ ì›”ê³¼ ìˆ˜ì¹˜ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            
            <!-- ë¡œë”© ì¤‘ í‘œì‹œ -->
            <div id="chart-loading" style="text-align: center; padding: 40px;">
                <p style="font-size: 18px; color: #666;">ğŸ“Š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                <div class="spinner" style="margin: 20px auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
            
            <!-- ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ (ì²˜ìŒì—” ìˆ¨ê¹€) -->
            <div id="chart-container" style="display: none;">
                <div class="time-chart-container" id="monthly-chart"></div>
                
                <!-- ë²”ë¡€ -->
                <div class="chart-legend">
                    <div class="legend-item">
                        <span class="legend-color joy-color"></span>
                        <span>í¬(ê¸°ì¨)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color anger-color"></span>
                        <span>ë…¸(í™”ë‚¨)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color sad-color"></span>
                        <span>ìŠ¬(ìŠ¬í””)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color love-color"></span>
                        <span>ì‚¬(ì‚¬ë‘)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color fun-color"></span>
                        <span>ë½(ì¦ê±°ì›€)</span>
                    </div>
                </div>
                
            <!-- ì¶”ê°€ ì„¤ëª… -->
                <div class="chart-note">
                    <p>ğŸ’¡ <strong>íŒ:</strong> ë§‰ëŒ€ê°€ ë†’ì„ìˆ˜ë¡ ë¦¬ë·°ê°€ ë§ì€ ì›”ì…ë‹ˆë‹¤! ë¦¬ë·° ê°œìˆ˜ê°€ ë§ìœ¼ë©´ì„œ í¬(ê¸°ì¨) ë¹„ìœ¨ì´ ë†’ì€ ì›”ì„ ì°¾ì•„ë³´ì„¸ìš”. ê·¸ ë‹¬ì´ ì´ ê°€ê²Œê°€ ê°€ì¥ ë¹›ë‚˜ëŠ” ìˆœê°„ì…ë‹ˆë‹¤! âœ¨</p>
                </div>
            </div>
            
            <!-- ì—ëŸ¬ ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="chart-error" style="display: none; text-align: center; padding: 40px; color: #888;">
                <p style="font-size: 18px;">ğŸ˜¢ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
            
            <!-- ë°ì´í„° ì—†ìŒ ë©”ì‹œì§€ -->
            <div id="chart-no-data" style="display: none; text-align: center; padding: 40px; color: #888;">
                <p style="font-size: 18px;">ğŸ˜¢ ìµœê·¼ 12ê°œì›”ê°„ ë¦¬ë·° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p style="font-size: 14px; margin-top: 10px;">ì´ ê°€ê²Œì˜ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>
            </div>
        </div>
        
        <!-- "ë” ëŠë¼ê¸°" ë²„íŠ¼ ë° ìˆ¨ê²¨ì§„ ì˜ì—­ -->
        <div class="detail-section">
            
            <!-- "ë” ëŠë¼ê¸°" ë²„íŠ¼ -->
            <button class="feel-more-btn" onclick="toggleEmotions()">
                ğŸ­ ë” ëŠë¼ê¸°
            </button>
            
            <!-- ë‚˜ë¨¸ì§€ ê°ì„±ì§€ìˆ˜ ì˜ì—­ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
            <div id="other-emotions" class="other-emotions" style="display: none;">
                <h4 class="emotion-subtitle">ë‚˜ë¨¸ì§€ ê°ì„±ì§€ìˆ˜</h4>
                
                <!-- ëª¨ë“  ê°ì„±ì§€ìˆ˜ë¥¼ ë°˜ë³µ -->
                {% for emotion, score in restaurant.emotion_score.items() %}
                
                    <!-- 80ì  ë¯¸ë§Œì¸ ê°ì •ë“¤ë§Œ í‘œì‹œ (ë‚˜ë¨¸ì§€ ê°ì„±) -->
                    {% if score < 80 %}
                    <div class="emotion-item">
                        <span class="emotion-label">{{ emotion }}</span>
                        <div class="emotion-bar-container">
                            <!-- ê°ì„±ì§€ìˆ˜ ë§‰ëŒ€ê·¸ë˜í”„ -->
                            <div class="emotion-bar" style="width: {{ (score * 100)|round(2) }}%">
                                {{ (score * 100)|round(2) }}%
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        
    </div>
    
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    
    <!-- â­ ë¹„ë™ê¸° ì°¨íŠ¸ ë¡œë”© ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¹„ë™ê¸°ë¡œ ì°¨íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            const s_idx = {{ restaurant.s_idx }};
            loadMonthlyChart(s_idx);
        });
        
        function loadMonthlyChart(s_idx) {
            fetch(`/api/monthly_emotion/${s_idx}`)
                .then(response => response.json())
                .then(result => {
                    // ë¡œë”© ìˆ¨ê¸°ê¸°
                    document.getElementById('chart-loading').style.display = 'none';
                    
                    if (!result.success) {
                        // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                        document.getElementById('chart-error').style.display = 'block';
                        return;
                    }
                    
                    const data = result.data;
                    
                    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´
                    if (!data.months || data.months.length === 0) {
                        document.getElementById('chart-no-data').style.display = 'block';
                        return;
                    }
                    
                    // ì°¨íŠ¸ ë Œë”ë§
                    renderChart(data);
                    document.getElementById('chart-container').style.display = 'block';
                })
                .catch(error => {
                    console.error('ì°¨íŠ¸ ë¡œë”© ì˜¤ë¥˜:', error);
                    document.getElementById('chart-loading').style.display = 'none';
                    document.getElementById('chart-error').style.display = 'block';
                });
        }
        
        function renderChart(data) {
            const chartContainer = document.getElementById('monthly-chart');
            const months = data.months;
            const reviewCounts = data.review_counts;
            const emotions = data.emotions;
            
            // ìµœëŒ€ ë¦¬ë·° ê°œìˆ˜ ê³„ì‚°
            const maxReviewCount = Math.max(...reviewCounts);
            
            // ê° ì›”ë³„ë¡œ ì°¨íŠ¸ ìƒì„±
            months.forEach((month, i) => {
                const reviewCount = reviewCounts[i];
                
                // ë†’ì´ ë¹„ìœ¨ ê³„ì‚°
                let heightRatio = (reviewCount / maxReviewCount * 100).toFixed(1);
                if (reviewCount > 0 && heightRatio < 20) {
                    heightRatio = 20;
                }
                
                // ì›” í‘œì‹œ (2024-01 -> 1ì›”)
                const monthText = month.split('-')[1] + 'ì›”';
                
                // ê°ì • ê°’
                const joyVal = emotions['í¬'][i] || 0;
                const angerVal = emotions['ë…¸'][i] || 0;
                const sadVal = emotions['ì• (ìŠ¬í””)'][i] || 0;
                const loveVal = emotions['ì• (ì‚¬ë‘)'][i] || 0;
                const funVal = emotions['ë½'][i] || 0;
                
                // HTML ìƒì„±
                const columnHtml = `
                    <div class="time-column">
                        <div class="time-bars" style="height: ${heightRatio}%">
                            <div class="time-bar joy-bar" style="flex: ${joyVal}"
                                title="${month} - ë¦¬ë·° ${reviewCount}ê°œ | í¬: ${joyVal}%"></div>
                            <div class="time-bar anger-bar" style="flex: ${angerVal}"
                                title="${month} - ë¦¬ë·° ${reviewCount}ê°œ | ë…¸: ${angerVal}%"></div>
                            <div class="time-bar sad-bar" style="flex: ${sadVal}"
                                title="${month} - ë¦¬ë·° ${reviewCount}ê°œ | ìŠ¬: ${sadVal}%"></div>
                            <div class="time-bar love-bar" style="flex: ${loveVal}"
                                title="${month} - ë¦¬ë·° ${reviewCount}ê°œ | ì‚¬: ${loveVal}%"></div>
                            <div class="time-bar fun-bar" style="flex: ${funVal}"
                                title="${month} - ë¦¬ë·° ${reviewCount}ê°œ | ë½: ${funVal}%"></div>
                        </div>
                        <div class="time-label">${monthText}</div>
                        <div class="review-count-label">${reviewCount}ê°œ</div>
                    </div>
                `;
                
                chartContainer.innerHTML += columnHtml;
            });
        }
    </script>
    
    <!-- ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ -->
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>